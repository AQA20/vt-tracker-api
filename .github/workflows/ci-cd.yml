name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  # ----------------------------------------------------------------------
  # STAGE 1: Continuous Integration (CI)
  # Runs on every push to checking code quality and tests.
  # ----------------------------------------------------------------------
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, xml, ctype, iconv, intl, pdo_sqlite, dom, filter, gd, iconv, json, mbstring, pdo
          coverage: none

      - name: Install Dependencies
        run: |
          composer install --prefer-dist --no-ansi --no-interaction --no-progress --no-scripts
          npm install

      - name: Setup Environment
        run: |
          cp .env.testing .env
          php artisan key:generate

      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache

      - name: Run Linting (Pint)
        run: ./vendor/bin/pint --test

      - name: Run Tests (PHPUnit)
        run: php artisan test

  # ----------------------------------------------------------------------
  # STAGE 2: Continuous Deployment (CD)
  # Runs only on push to main and if tests pass.
  # ----------------------------------------------------------------------
  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Stop execution on error
            set -e

            echo "üöÄ Starting Deployment..."
            
            # Navigate to project directory
            cd /var/www/vt-tracker-api

            # Pull latest changes
            echo "üì• Pulling latest code..."
            git pull origin main

            # Update Docker Images & Containers
            echo "üê≥ Rebuilding containers..."
            docker compose up -d --build

            # Run Laravel Post-Deployment Tasks
            echo "üîß Running Laravel tasks..."
            docker compose exec -T app php artisan migrate --force
            docker compose exec -T app php artisan optimize:clear
            docker compose exec -T app php artisan config:cache
            docker compose exec -T app php artisan route:cache
            docker compose exec -T app php artisan view:cache
            docker compose exec -T app php artisan db:seed --force
            
            echo "‚úÖ Deployment Successful!"
